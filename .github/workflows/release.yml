name: Android Release

env:
  SIGNING_KEY_ALIAS: android-release-key
  SIGNING_STORE_PASSWORD: "android123"
  SIGNING_KEY_PASSWORD: "android123"

on:
  workflow_dispatch:
  push:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Create keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        mkdir -p app
        echo $KEYSTORE_BASE64 | base64 -d > app/release-keystore.jks
    
    - name: Grant permission
      run: chmod +x gradlew

    - name: Build AAB & Signed
      env:
        SIGNING_STORE_PASSWORD: ${{ env.SIGNING_STORE_PASSWORD }}
        SIGNING_KEY_ALIAS: ${{ env.SIGNING_KEY_ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ env.SIGNING_KEY_PASSWORD }}
      run: |
        ./gradlew clean bundleRelease assembleRelease
                  
    - name: Verify Signing
      id: apk
      run: |
        APK=$(find . -name "*.apk" | head -n1)
        TAG=$(basename "$APK" .apk)
        echo "TAG=$TAG" >> $GITHUB_OUTPUT
        echo "APK=$APK" >> $GITHUB_OUTPUT

    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ steps.apk.outputs.TAG }}"
        files: ${{ steps.apk.outputs.APK }}

